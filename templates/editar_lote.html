{% extends "base.html" %}

{% block content %}

<div class="container py-5">
    
    {% if item %}
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="text-serif fw-bold mb-0" style="color: var(--secondary-color);">Editar Lotes</h2>
                <p class="text-muted mb-0">Modificación masiva del historial de stock.</p>
            </div>
            <a href="{{ url_for('ver_lotes', item_id=item._id|string) }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Cancelar y Volver
            </a>
        </div>

        <div class="card border-0 shadow-sm mb-4 bg-light">
            <div class="card-body py-3 px-4 d-flex align-items-center gap-3">
                <div class="bg-white p-2 rounded-circle text-secondary shadow-sm">
                    <i class="fas fa-edit"></i>
                </div>
                <div>
                    <h6 class="fw-bold mb-0 text-secondary">Editando: {{ item.nombre or item.producto }}</h6>
                    <small class="text-muted">Total Lotes: {{ lotes|length }}</small>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm" style="border-radius: 12px; overflow: hidden;">
            <div class="card-body p-0">
                <form method="POST">
                    
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead style="background-color: var(--secondary-color); color: white;">
                                <tr>
                                    <th class="py-3 ps-4" style="width: 50px;">#</th>
                                    <th class="py-3" style="min-width: 100px;">ID Lote</th>
                                    <th class="py-3" style="min-width: 160px;"><i class="far fa-calendar-plus me-2"></i>Entrada</th>
                                    <th class="py-3" style="min-width: 160px;"><i class="far fa-calendar-times me-2"></i>Caducidad</th>
                                    <th class="py-3" style="min-width: 120px; width: 120px;"><i class="fas fa-boxes me-2"></i>Uds.</th>
                                    <th class="py-3 pe-4" style="min-width: 140px; width: 140px;"><i class="fas fa-euro-sign me-2"></i>Coste</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lote in lotes %}
                                    <tr>
                                        <td class="ps-4 text-muted fw-bold">{{ loop.index }}</td>
                                        
                                        <td class="font-monospace small fw-bold text-secondary">
                                            {{ lote.lote_id or ('L-' ~ loop.index) }}
                                        </td>
                                        
                                        <td>
                                            <input type="date" 
                                                   name="fecha_entrada_{{ loop.index0 }}" 
                                                   class="form-control form-control-sm border-0 bg-light" 
                                                   value="{% if lote.fecha_entrada %}{{ lote.fecha_entrada.strftime('%Y-%m-%d') }}{% endif %}">
                                        </td>
                                        
                                        <td>
                                            <input type="date" 
                                                   name="fecha_caducidad_{{ loop.index0 }}" 
                                                   class="form-control form-control-sm border-0 bg-light"
                                                   value="{% if lote.fecha_caducidad %}{{ lote.fecha_caducidad.strftime('%Y-%m-%d') }}{% endif %}">
                                        </td>
                                        
                                        <td>
                                            <input type="number" 
                                                   name="lote_unidades_{{ loop.index0 }}" 
                                                   class="form-control form-control-sm fw-bold text-center border-0 bg-light" 
                                                   min="0" 
                                                   value="{{ lote.unidades or 0 }}">
                                        </td>
                                        
                                        <td class="pe-4">
                                            <div class="input-group input-group-sm">
                                                <input type="number" 
                                                       step="0.01" 
                                                       name="coste_{{ loop.index0 }}" 
                                                       class="form-control text-end border-0 bg-light" 
                                                       value="{{ lote.coste or 0.0 }}">
                                                <span class="input-group-text border-0 bg-light">€</span>
                                            </div>
                                        </td>
                                    </tr>
                                {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center py-5 text-muted">
                                            <i class="fas fa-box-open mb-3" style="font-size: 2rem; opacity: 0.3;"></i>
                                            <p>No hay lotes para editar.</p>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-end align-items-center bg-white p-4 border-top sticky-bottom">
                        <small class="text-muted me-3">Revisa los datos antes de guardar.</small>
                        <button type="submit" class="btn btn-primary-custom text-white shadow-sm px-4">
                            <i class="fas fa-save me-2"></i> Guardar Cambios
                        </button>
                    </div>

                </form>
            </div>
        </div>

    {% else %}
        <div class="text-center py-5">
            <h3 class="text-danger">Producto no encontrado</h3>
            <a href="{{ url_for('inventario') }}" class="btn btn-secondary mt-3">Volver al Inventario</a>
        </div>
    {% endif %}

</div>

{% endblock %}