<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>EstadÃ­sticas Generales - Comedor Social</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 40px 20px;
        }

        .container {
            max-width: 1400px;
            margin: auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 40px;
            color: #333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 columnas en una fila */
            gap: 30px;
            align-items: start;
        }

        .stat-card {
            background-color: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: transform 0.25s ease, box-shadow 0.25s ease;
            display: flex;
            flex-direction: column;
        }

        .stat-card:hover {
            transform: scale(1.03);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .card-tab {
            background-color: #4CAF50;
            color: white;
            padding: 10px 0;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
        }

        .card-content {
            padding: 25px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h2.card-title {
            color: #333;
            font-size: 18px;
            margin-bottom: 20px;
            text-align: center;
        }

        canvas {
            width: 100% !important;
            max-height: 400px;
        }

        .card-link {
            display: inline-block;
            margin-top: 15px;
            padding: 8px 14px;
            background-color: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 20px;
            font-weight: bold;
            font-size: 13px;
            transition: background 0.3s ease;
        }

        .card-link:hover {
            background-color: #43a047;
        }

        @media (max-width: 1000px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            }
        }
    </style>
</head>

<body>
<div class="container">
    <h1>ðŸ“Š EstadÃ­sticas Generales</h1>

    <div class="stats-grid">
        <!-- DONACIONES -->
        <div class="stat-card">
            <div class="card-tab">Datos de Donaciones</div>
            <div class="card-content">
                <h2 class="card-title">Donaciones por Municipio</h2>
                <canvas id="donacionesChart"></canvas>
                <a href="/stats/donaciones" class="card-link">Ver mÃ¡s â†’</a>
            </div>
        </div>

        <!-- INVENTARIO -->
        <div class="stat-card">
            <div class="card-tab">Datos de Inventario</div>
            <div class="card-content">
                <h2 class="card-title">Stock actual por Producto</h2>
                <canvas id="inventarioChart"></canvas>
                <a href="/stats/inventario" class="card-link">Ver mÃ¡s â†’</a>
            </div>
        </div>

        <!-- PREDICCIONES -->
        <div class="stat-card">
            <div class="card-tab">Datos de Predicciones</div>
            <div class="card-content">
                <h2 class="card-title">Predicciones por CÃ³digo Postal</h2>
                <canvas id="prediccionesChart"></canvas>
                <a href="/stats/predicciones" class="card-link">Ver mÃ¡s â†’</a>
            </div>
        </div>
    </div>
</div>

<script>
    /* ================= DONACIONES ================= */
    const donaciones = {{ don_por_muni | tojson }};
    new Chart(document.getElementById("donacionesChart"), {
        type: "bar",
        data: {
            labels: donaciones.map(d => d.municipio),
            datasets: [{ 
                label: "Unidades donadas", 
                data: donaciones.map(d => d.total_unidades),
                backgroundColor: '#A3E4D7'
            }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
    });

 /* ================= INVENTARIO (HORIZONTAL) ================= */
    const inventario = {{ inv_por_prod | tojson }};
    new Chart(document.getElementById("inventarioChart"), {
        type: "bar",
        data: {
            labels: inventario.map(i => {
                // extraer solo el nombre del producto eliminando categorÃ­a y cantidades
                let nombre = i.nombre;
                // eliminar todo antes del primer espacio si viene la categorÃ­a
                if (nombre.includes(' ')) {
                    const partes = nombre.split(' ');
                    nombre = partes.slice(1).join(' ');
                }
                // eliminar cualquier texto entre parÃ©ntesis
                nombre = nombre.replace(/\(.*\)/, '').trim();
                return nombre;
            }),
            datasets: [{ 
                label: "Stock total", 
                data: inventario.map(i => i.stock_total),
                backgroundColor: '#FFD1A3'
            }]
        },
        options: { 
            indexAxis: 'y', 
            responsive: true, 
            plugins: { legend: { display: false } }
        }
    });


    /* ================= PREDICCIONES ================= */
    const predicciones = {{ pred_por_cp | tojson }};
    new Chart(document.getElementById("prediccionesChart"), {
        type: "bar",
        data: {
            labels: predicciones.map(p => p.codigo_postal),
            datasets: [{ 
                label: "NÃºmero de predicciones", 
                data: predicciones.map(p => p.num_predicciones),
                backgroundColor: '#C3A3FF'
            }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
    });
</script>

</body>
</html>
