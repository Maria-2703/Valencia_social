{% extends "base.html" %}

{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container py-5">
    
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h2 class="text-serif fw-bold mb-0" style="color: var(--secondary-color);">Análisis de Inventario</h2>
            <p class="text-muted mb-0">Estado actual del stock, valoración económica y previsión de caducidades.</p>
        </div>
        <a href="/stats" class="btn btn-outline-secondary btn-sm rounded-pill px-3">
            <i class="fas fa-arrow-left me-1"></i> Volver al panel general
        </a>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="border-radius: 15px;">
                <div class="card-header bg-white border-bottom py-3 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold text-secondary"><i class="fas fa-euro-sign me-2"></i>Evolución de Costes (Entradas)</h6>
                </div>
                <div class="card-body">
                    <div style="height: 300px;">
                        <canvas id="chartCoste"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-8">
            <div class="card h-100 border-0 shadow-sm" style="border-radius: 15px;">
                <div class="card-header bg-white border-bottom py-3">
                    <h6 class="mb-0 fw-bold text-secondary"><i class="fas fa-tags me-2"></i>Stock por Categoría</h6>
                </div>
                <div class="card-body">
                    <div style="height: 300px;">
                        <canvas id="chartCategoria"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card h-100 border-0 shadow-sm" style="border-radius: 15px;">
                <div class="card-header bg-white border-bottom py-3">
                    <h6 class="mb-0 fw-bold text-secondary"><i class="fas fa-truck-loading me-2"></i>Origen del Stock</h6>
                </div>
                <div class="card-body d-flex justify-content-center align-items-center">
                    <div style="height: 250px; width: 100%;">
                        <canvas id="chartProveedor"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card h-100 border-0 shadow-sm" style="border-radius: 15px;">
                <div class="card-header bg-white border-bottom py-3">
                    <h6 class="mb-0 fw-bold text-secondary"><i class="fas fa-cubes me-2"></i>Stock por Producto</h6>
                </div>
                <div class="card-body">
                    <div style="height: 400px;"> 
                        <canvas id="chartProducto"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100 border-0 shadow-sm" style="border-radius: 15px;">
                <div class="card-header bg-white border-bottom py-3">
                    <h6 class="mb-0 fw-bold text-secondary"><i class="fas fa-map-marked-alt me-2"></i>Distribución Geográfica</h6>
                </div>
                <div class="card-body">
                    <div style="height: 400px;">
                        <canvas id="chartMunicipio"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="border-radius: 15px; border-left: 5px solid #ff3b30;">
                <div class="card-header bg-white border-bottom py-3">
                    <h6 class="mb-0 fw-bold text-danger"><i class="fas fa-hourglass-half me-2"></i>Proyección de Caducidades</h6>
                </div>
                <div class="card-body">
                    <div style="height: 250px;">
                        <canvas id="chartCaducidad"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // Configuración Global Chart.js
    Chart.defaults.font.family = "'Lato', sans-serif";
    Chart.defaults.color = '#666';

    // ==== Datos de Flask ====
    const invProducto = {{ inv_por_prod | tojson }};
    const invCategoria = {{ inv_por_cat | tojson }};
    const invProveedor = {{ inv_por_proveedor | tojson }};
    const invCaducidad = {{ inv_por_caducidad | tojson }};
    const invMuni = {{ inv_por_muni | tojson }};
    const invCoste = {{ inv_por_coste | tojson }};

    // 1. PRODUCTO (VERTICAL AHORA)
    new Chart(document.getElementById("chartProducto"), {
        type: "bar",
        data: {
            labels: invProducto.map(i => {
                const partes = i.nombre.split('-');
                let nombre = partes.length > 1 ? partes[1].trim() : i.nombre;
                nombre = nombre.replace(/\(.*\)/, '').trim(); 
                return nombre.substring(0, 15); // Limitar caracteres para que quepan en vertical
            }),
            datasets: [{
                label: "Stock Total",
                data: invProducto.map(i => i.stock_total),
                backgroundColor: 'rgba(201, 108, 77, 0.7)', // Terracota
                borderRadius: 4
            }]
        },
        options: { 
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { 
                y: { beginAtZero: true, grid: { borderDash: [2, 4] } }, 
                x: { grid: { display: false } } 
            }
        }
    });

    // 2. CATEGORÍA (Vertical)
    new Chart(document.getElementById("chartCategoria"), {
        type: "bar",
        data: {
            labels: invCategoria.map(c => c.categoria),
            datasets: [{
                label: "Stock Total",
                data: invCategoria.map(c => c.total_stock),
                backgroundColor: 'rgba(106, 154, 226, 0.7)', // Azul claro
                borderRadius: 4
            }]
        },
        options: { 
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, grid: { borderDash: [2, 4] } }, x: { grid: { display: false } } }
        }
    });

    // 3. PROVEEDOR (Pie)
    new Chart(document.getElementById("chartProveedor"), {
        type: "pie",
        data: {
            labels: invProveedor.map(p => p.tipo),
            datasets: [{
                data: invProveedor.map(p => p.total_unidades),
                backgroundColor: ['#28a745', '#ffc107'],
                borderWidth: 0
            }]
        },
        options: { 
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { usePointStyle: true } } }
        }
    });

    // 4. CADUCIDAD (Línea Roja)
    new Chart(document.getElementById("chartCaducidad"), {
        type: "line",
        data: {
            labels: invCaducidad.map(c => {
                const d = new Date(c.fecha_caducidad);
                const mm = String(d.getMonth() + 1).padStart(2,'0');
                const yy = String(d.getFullYear()).slice(-2);
                return `${mm}/${yy}`;
            }),
            datasets: [{
                label: "Unidades a Caducar",
                data: invCaducidad.map(c => c.total_unidades),
                backgroundColor: 'rgba(255, 59, 48, 0.1)',
                borderColor: '#ff3b30', // Rojo
                fill: true,
                tension: 0.4
            }]
        },
        options: { 
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, grid: { borderDash: [2, 4] } }, x: { grid: { display: false } } }
        }
    });

    // 5. MUNICIPIO (Barras Verticales)
    new Chart(document.getElementById("chartMunicipio"), {
        type: "bar",
        data: {
            labels: invMuni.map(m => m.municipio),
            datasets: [{
                label: "Stock Total",
                data: invMuni.map(m => m.total_stock),
                backgroundColor: 'rgba(226, 160, 63, 0.7)', // Ocre
                borderRadius: 4
            }]
        },
        options: { 
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, grid: { borderDash: [2, 4] } }, x: { grid: { display: false } } }
        }
    });

    // 6. COSTE (Línea Verde)
    new Chart(document.getElementById("chartCoste"), {
        type: "line",
        data: {
            labels: invCoste.map(c => c.fecha),
            datasets: [{
                label: "Gasto Total (€)",
                data: invCoste.map(c => c.total_gasto),
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                borderColor: '#28a745', // Verde Dinero
                fill: true,
                tension: 0.4
            }]
        },
        options: { 
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, grid: { borderDash: [2, 4] } }, x: { grid: { display: false } } }
        }
    });
</script>

{% endblock %}